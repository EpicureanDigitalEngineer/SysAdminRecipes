



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A collection of recipes (articles, guides, HowTos, instructables) around system administration and digital services">
      
      
        <link rel="canonical" href="https://epicureandigitalengineer.github.io/SysAdminRecipes/freebsd/jails/">
      
      
        <meta name="author" content="The Epicurean Digital Engineer (EpicureanDigitalEngineer@gmail.com)">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.13">
    
    
      
        <title>A Jail-based FreeBSD Application Server - System Administration Recipes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.077507d7.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-install-a-set-of-freebsd-jails-on-12x" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://epicureandigitalengineer.github.io/SysAdminRecipes/" title="System Administration Recipes" class="md-header-nav__button md-logo" aria-label="System Administration Recipes">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            System Administration Recipes
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              A Jail-based FreeBSD Application Server
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/EpicureanDigitalEngineer/SysAdminRecipes.git/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://epicureandigitalengineer.github.io/SysAdminRecipes/" title="System Administration Recipes" class="md-nav__button md-logo" aria-label="System Administration Recipes">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    System Administration Recipes
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/EpicureanDigitalEngineer/SysAdminRecipes.git/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="SysAdmin Recipes" class="md-nav__link">
      SysAdmin Recipes
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      FreeBSD Recipes
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="FreeBSD Recipes" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        FreeBSD Recipes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="About FreeBSD Recipes" class="md-nav__link">
      About FreeBSD Recipes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../secure-server/" title="A Secure FreeBSD Server in the cloud" class="md-nav__link">
      A Secure FreeBSD Server in the cloud
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        A Jail-based FreeBSD Application Server
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="A Jail-based FreeBSD Application Server" class="md-nav__link md-nav__link--active">
      A Jail-based FreeBSD Application Server
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem-statement" class="md-nav__link">
    Problem Statement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concepts" class="md-nav__link">
    Concepts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation-process-for-a-new-jail" class="md-nav__link">
    Installation process for a new jail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-the-jail-subsystem-on-the-host" class="md-nav__link">
    Configure the Jail subsystem on the host
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-jail" class="md-nav__link">
    Create the jail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-the-host" class="md-nav__link">
    Configure the host
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-the-jail" class="md-nav__link">
    Configure the jail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#start-the-jail" class="md-nav__link">
    Start the jail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrade-jail-to-the-latest-patch-level" class="md-nav__link">
    Upgrade jail to the latest patch level
  </a>
  
    <nav class="md-nav" aria-label="Upgrade jail to the latest patch level">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-the-pkg-system-latest-version" class="md-nav__link">
    Install the pkg system (latest version)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-packages-you-need" class="md-nav__link">
    Install packages you need
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ghost/" title="Installing the ghost blogging platform in FreeBSD" class="md-nav__link">
      Installing the ghost blogging platform in FreeBSD
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../notyet/" title="A Windows Domain Controller using SAMBA on FreeBSD" class="md-nav__link">
      A Windows Domain Controller using SAMBA on FreeBSD
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#problem-statement" class="md-nav__link">
    Problem Statement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concepts" class="md-nav__link">
    Concepts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation-process-for-a-new-jail" class="md-nav__link">
    Installation process for a new jail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-the-jail-subsystem-on-the-host" class="md-nav__link">
    Configure the Jail subsystem on the host
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-the-jail" class="md-nav__link">
    Create the jail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-the-host" class="md-nav__link">
    Configure the host
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-the-jail" class="md-nav__link">
    Configure the jail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#start-the-jail" class="md-nav__link">
    Start the jail
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrade-jail-to-the-latest-patch-level" class="md-nav__link">
    Upgrade jail to the latest patch level
  </a>
  
    <nav class="md-nav" aria-label="Upgrade jail to the latest patch level">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-the-pkg-system-latest-version" class="md-nav__link">
    Install the pkg system (latest version)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#install-packages-you-need" class="md-nav__link">
    Install packages you need
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/EpicureanDigitalEngineer/SysAdminRecipes.git/edit/master/docs/freebsd/jails.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="how-to-install-a-set-of-freebsd-jails-on-12x">How to install (a set of) FreeBSD Jails (on 12.x)<a class="headerlink" href="#how-to-install-a-set-of-freebsd-jails-on-12x" title="Permanent link">&para;</a></h1>
<h2 id="problem-statement">Problem Statement<a class="headerlink" href="#problem-statement" title="Permanent link">&para;</a></h2>
<p>Having installed a FreeBSD server, you now want to run multiple services (e.g. a <a href="../ghost/">blogging platform</a>, a NextCloud instance, ...) in a controlled and secure manner. Under Linux, you would have used <code class="codehilite"><span class="err">containers</span></code>. Under FreeBSD, you use <a href="https://www.freebsd.org/doc/handbook/jails.html"><code class="codehilite"><span class="err">jails</span></code></a>. Jails appeared much earlier than containers and they addressed specifically the issue of isolating a set of processes from each other to obtain multi-tenancy of services in a more controllable and secure way. Various meta-systems exist to manage jails, <a href="https://www.freebsd.org/doc/handbook/jails-ezjail.html">ezjail</a> among them.</p>
<p>This recipe explains how to create a set of jails in an already existing and configured FreeBSD 12.x server (see for example <a href="secure-server">here</a> how to install a FreeBSD secure server in the cloud). It does not use any meta-tools like <code class="codehilite"><span class="err">ezjail</span></code> but proposes a set of conventions and concepts that facilitate the management of jails the low-level way. Therefore, it is addressed to those want to have a good understanding and control of what is happening under the hood.</p>
<h2 id="concepts">Concepts<a class="headerlink" href="#concepts" title="Permanent link">&para;</a></h2>
<p>Running services in jails in FreeBSD is the "equivalent" to running services in containers in Linux (without the automation!). Jails can be configured in different ways to serve different purposes. Here, we consider that a jail is a miniature FreeBSD machine which is created to run specific services in a walled environment and which has its own network stack bridging the jail interfaces with the physical, uplink interface. We expected that the host FreeBSD server will eventually have multiple jails.</p>
<p>The configuration of the jail system resides in <code class="codehilite"><span class="err">/etc/jails</span></code>. It is in this file that we will be establishing a set of conventions that should make the management of the collection of jails (and the creation of new us) considerably more manageable. The file allows some parametrisation as well as the execution of scripts that automate a number of tasks like networking.</p>
<p>Conventions/patterns used include the following:</p>
<ol>
<li><strong>Jail Location</strong>: Jails are installed under under <code class="codehilite"><span class="err">/jail/&lt;jail name&gt;</span></code>. In case you are using <code class="codehilite"><span class="err">zfs</span></code> you should be creating a new dataset accordingly and take advantage of the <code class="codehilite"><span class="err">zfs</span></code> functionality to arrange for snapshots,  backups or migrations/cloning. </li>
<li><strong>Jail privileges</strong>: Jails are run as root - take good care to ensure the level of security you want to obtain from the system.</li>
<li><strong>Jail networking</strong>: a <code class="codehilite"><span class="err">bridge0</span></code> is created (if not existing) upon start of the first jail . Each jail is assigned an <a href="https://www.freebsd.org/cgi/man.cgi?query=epair"><code class="codehilite"><span class="err">epair</span></code></a> interface named  <code class="codehilite"><span class="err">jail0</span></code> inside the jail. The outside part of the pair is added to the bridge. The uplink interface is also added to the bridge, effectively allowing jails to have a full networking stack (including loopback). When a jail is stopped, the corresponding <code class="codehilite"><span class="err">epair</span></code> interface is removed from the bridge and destroyed. </li>
</ol>
<p>Based on these conventions once your <code class="codehilite"><span class="err">/etc/jails</span></code> template has been prepared, adding a jail to the host system requires just two steps:</p>
<ol>
<li>create a directory (or <code class="codehilite"><span class="err">zfs dataset</span></code>) and install the required jail files; perform initial basic configuration</li>
<li>append information about your jail to the <code class="codehilite"><span class="err">/etc/jails.conf</span></code> file and start the jail</li>
</ol>
<p>The size of FreeBSD allows the jails to be relatively compact: 587MB for the base install or 1.6GB with the ports tree and current <code class="codehilite"><span class="err">portsnap(8)</span></code> information. As the jail is seen as an independent system, it will need to be maintained as a separate system (i.e. through <code class="codehilite"><span class="err">freebsd-update</span></code> and <code class="codehilite"><span class="err">pkg upgrade</span></code>).</p>
<p>For the sake of example, the name of the host will be <code class="codehilite"><span class="err">host</span></code> while the the name of the jail to be created would be <code class="codehilite"><span class="err">myjail1</span></code>. </p>
<h2 id="installation-process-for-a-new-jail">Installation process for a new jail<a class="headerlink" href="#installation-process-for-a-new-jail" title="Permanent link">&para;</a></h2>
<ol>
<li>Configure and start the jail service with the conventions decided (if not done)</li>
<li>Create a space for your new jail and perform the basic installation/configuration</li>
<li>Update the <code class="codehilite"><span class="err">/etc/jails.conf</span></code> file to make your jail known</li>
<li>Start the jail and finalise the configuration</li>
</ol>
<h2 id="configure-the-jail-subsystem-on-the-host">Configure the Jail subsystem on the host<a class="headerlink" href="#configure-the-jail-subsystem-on-the-host" title="Permanent link">&para;</a></h2>
<p><code class="codehilite"><span class="err">/etc/rc.conf</span></code> and <code class="codehilite"><span class="err">/etc/jail.conf</span></code></p>
<p>Add an entry for <code class="codehilite"><span class="err">myjail</span></code> on <code class="codehilite"><span class="err">/etc/hosts</span></code> (\'\'10.166.167.20 dc03\'\') of the host machine. If not already done, add <code class="codehilite"><span class="err">jail_enable=&quot;YES&quot;</span></code>
to <code class="codehilite"><span class="err">/etc/rc.conf</span></code></p>
<div class="codehilite"><pre><span></span><code><span class="c1">################################################################</span>
<span class="c1">##      /etc/jail.conf                                         #</span>
<span class="c1">##      Basic Jail configuration for multiple Jails            #</span>
<span class="c1">##      The Epicurean Digital Engineer - 2020                  #</span>
<span class="c1">################################################################</span>

<span class="c1">## Global section</span>

exec.system_user  <span class="o">=</span> <span class="s2">&quot;root&quot;</span><span class="p">;</span>
exec.jail_user    <span class="o">=</span> <span class="s2">&quot;root&quot;</span><span class="p">;</span>
mount.devfs<span class="p">;</span>
allow.raw_sockets<span class="p">;</span>
allow.sysvipc<span class="p">;</span>
<span class="nv">devfs_ruleset</span>     <span class="o">=</span> <span class="s2">&quot;5&quot;</span><span class="p">;</span>

<span class="c1">## Networking</span>

<span class="nv">$uplinkdev</span>        <span class="o">=</span> <span class="s2">&quot;re0&quot;</span><span class="p">;</span>
vnet<span class="p">;</span>
vnet.interface    <span class="o">=</span> <span class="s2">&quot;jail0&quot;</span><span class="p">;</span>  <span class="c1"># default vnet interface</span>
exec.prestart     <span class="o">=</span> <span class="s2">&quot;ifconfig bridge0 &gt; /dev/null 2&gt; /dev/null || ( ifconfig bridge0 create up &amp;&amp; ifconfig bridge0 addm </span><span class="nv">$uplinkdev</span><span class="s2"> )&quot;</span><span class="p">;</span>
exec.prestart    +<span class="o">=</span> <span class="s2">&quot;ifconfig </span><span class="nv">$epair</span><span class="s2"> create up                 || echo &#39;Skipped creating epair(exists?)&#39;&quot;</span><span class="p">;</span>
exec.prestart    +<span class="o">=</span> <span class="s2">&quot;ifconfig bridge0 addm </span><span class="si">${</span><span class="nv">epair</span><span class="si">}</span><span class="s2">a           || echo &#39;Skipped adding bridge member (already member?)&#39;&quot;</span><span class="p">;</span>
exec.created      <span class="o">=</span> <span class="s2">&quot;ifconfig </span><span class="si">${</span><span class="nv">epair</span><span class="si">}</span><span class="s2">b name jail0             || echo &#39;Skipped renaming ifdev to jail0 (looks bad...)&#39;&quot;</span><span class="p">;</span>
exec.clean<span class="p">;</span>
exec.start        <span class="o">=</span> <span class="s2">&quot;/bin/sh /etc/rc&quot;</span><span class="p">;</span>
exec.stop         <span class="o">=</span> <span class="s2">&quot;/bin/sh /etc/rc.shutdown&quot;</span><span class="p">;</span>
exec.poststop     <span class="o">=</span> <span class="s2">&quot;ifconfig bridge0 deletem </span><span class="si">${</span><span class="nv">epair</span><span class="si">}</span><span class="s2">a&quot;</span><span class="p">;</span>
exec.poststop    +<span class="o">=</span> <span class="s2">&quot;ifconfig </span><span class="si">${</span><span class="nv">epair</span><span class="si">}</span><span class="s2">a destroy&quot;</span><span class="p">;</span>

<span class="c1">#</span>
<span class="c1">#   Information about individual jails</span>
<span class="c1">#   provided here for reference</span>
<span class="c1">#   to be added only when a jail is added!</span>
<span class="c1">#</span>

myjail1 <span class="o">{</span>
  host.hostname   <span class="o">=</span> myjail1.example.com<span class="p">;</span>
  <span class="nv">path</span>            <span class="o">=</span> /jail/myjail1<span class="p">;</span>
  <span class="nv">$epair</span>          <span class="o">=</span> <span class="s2">&quot;epair0&quot;</span><span class="p">;</span>  <span class="c1"># must be unique in every jail</span>
<span class="o">}</span>

myjail2 <span class="o">{</span>
  host.hostname   <span class="o">=</span> myjail2.example.com<span class="p">;</span>
  <span class="nv">path</span>            <span class="o">=</span> /jail/myjail2<span class="p">;</span>
  <span class="nv">$epair</span>          <span class="o">=</span> <span class="s2">&quot;epair1&quot;</span><span class="p">;</span>  <span class="c1"># must be unique in every jail</span>
<span class="o">}</span>

myjail3 <span class="o">{</span>
  host.hostname   <span class="o">=</span> myjail2.example.com<span class="p">;</span>
  <span class="nv">path</span>            <span class="o">=</span> /jail/myjail3<span class="p">;</span>
  <span class="nv">$epair</span>          <span class="o">=</span> <span class="s2">&quot;epair2&quot;</span><span class="p">;</span>  <span class="c1"># must be unique in every jail</span>
<span class="o">}</span>
</code></pre></div>

<h2 id="create-the-jail">Create the jail<a class="headerlink" href="#create-the-jail" title="Permanent link">&para;</a></h2>
<p>The complete Jail after finished installation takes less size then 587 MB. With complete FreeBSD Ports tree and current <code class="codehilite"><span class="err">portsnap(8)</span></code> information it takes about 1.6 GB of space.</p>
<div class="codehilite"><pre><span></span><code>$ mkdir -p /jail/myjail <span class="c1"># for a ufs installation</span>
$ fetch -o - http://ftp.freebsd.org/pub/FreeBSD/releases/amd64/12.1-RELEASE/base.txz <span class="p">|</span> tar --unlink -xpJf - -C /jail/myjail
</code></pre></div>

<h2 id="configure-the-host">Configure the host<a class="headerlink" href="#configure-the-host" title="Permanent link">&para;</a></h2>
<h2 id="configure-the-jail">Configure the jail<a class="headerlink" href="#configure-the-jail" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="c1">################################################################</span>
<span class="c1">#  /etc/rc.conf for myjail - a jailed service                  #</span>
<span class="c1">################################################################</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># Network Configuration</span>
<span class="c1">#</span>
<span class="nv">hostname</span><span class="o">=</span><span class="s2">&quot;myjail.example.com&quot;</span>
<span class="nv">defaultrouter</span><span class="o">=</span><span class="s2">&quot;10.6.6.1&quot;</span>
<span class="nv">ifconfig_jail0</span><span class="o">=</span><span class="s2">&quot;inet 10.6.6.2 netmask 255.255.255.0&quot;</span>

<span class="c1"># DAEMONS | yes</span>
<span class="nv">syslogd_flags</span><span class="o">=</span><span class="s2">&quot;-s -s&quot;</span>

<span class="c1"># DAEMONS | no</span>
<span class="nv">sshd_enable</span><span class="o">=</span>NO
<span class="nv">sendmail_enable</span><span class="o">=</span>NONE
<span class="nv">sendmail_submit_enable</span><span class="o">=</span>NO
<span class="nv">sendmail_outbound_enable</span><span class="o">=</span>NO
<span class="nv">sendmail_msp_queue_enable</span><span class="o">=</span>NO

<span class="c1"># OTHER</span>
  <span class="nv">clear_tmp_enable</span><span class="o">=</span>YES
  <span class="nv">clear_tmp_X</span><span class="o">=</span>YES
  <span class="nv">dumpdev</span><span class="o">=</span>NO
  <span class="nv">update_motd</span><span class="o">=</span>NO
  <span class="nv">keyrate</span><span class="o">=</span>fast
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="err">domain example.com</span>
<span class="err">search example.com</span>
<span class="err">nameserver 8.8.8.8</span>
<span class="err">nameserver 1.1.1.1</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="o">[</span>root@host /jail<span class="o">]</span>$ chroot /jail/myjail tzsetup
<span class="o">[</span>root@host /jail<span class="o">]</span>$ chroot /jail/myjail newaliases -v
</code></pre></div>

<h2 id="start-the-jail">Start the jail<a class="headerlink" href="#start-the-jail" title="Permanent link">&para;</a></h2>
<p>Now that the jail has been created, you may start it and check
everything works.</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>root@host /jail<span class="o">]</span>$ service jail start myjail1
Starting jails: myjail1.
<span class="o">[</span>root@host /jail<span class="o">]</span>$ jexec myjail1 csh
</code></pre></div>

<h2 id="upgrade-jail-to-the-latest-patch-level">Upgrade jail to the latest patch level<a class="headerlink" href="#upgrade-jail-to-the-latest-patch-level" title="Permanent link">&para;</a></h2>
<p>To upgrade your new jail to the latest patch level use <code class="codehilite"><span class="err">freebsd-update -b</span></code> as follows:</p>
<div class="codehilite"><pre><span></span><code><span class="o">[</span>root@host /jail<span class="o">]</span>$ freebsd-update -v /jail/myjail1 fetch
<span class="o">[</span>root@host /jail<span class="o">]</span>$ freebsd-update -v /jail/myjail1 install
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This presupposes that you are already on the latest patch level for your host system. If not, perform the <code class="codehilite"><span class="err">freebsd-update</span></code> on the host first to ensure that your kernel and userland versions will match (use <code class="codehilite"><span class="err">uname -UK</span></code> to verify if in doubt).</p>
</div>
<h3 id="install-the-pkg-system-latest-version">Install the pkg system (latest version)<a class="headerlink" href="#install-the-pkg-system-latest-version" title="Permanent link">&para;</a></h3>
<p>To allow to receive quicker updates, we switch to the \"latest version\"
pkg repository.</p>
<div class="codehilite"><pre><span></span><code><span class="gp">root@myjail1:/ $</span> sed -i <span class="s1">&#39;&#39;</span> s/quarterly/latest/g /etc/pkg/FreeBSD.conf
<span class="gp">root@myjail1:/ $</span> pkg update
<span class="go">The package management tool is not yet installed on your system.</span>
<span class="go">Do you want to fetch and install it now? [y/N]: y</span>
<span class="go">Bootstrapping pkg from pkg+http://pkg.FreeBSD.org/FreeBSD:12:amd64/latest, please wait...</span>
<span class="go">Verifying signature with trusted certificate pkg.freebsd.org.2013102301... done</span>
<span class="go">[myjail1.example.com] Installing pkg-1.12.0...</span>
<span class="go">[myjail1.example.com] Extracting pkg-1.12.0: 100%</span>
<span class="go">Updating FreeBSD repository catalogue...</span>
<span class="go">[myjail1.example.com] Fetching meta.txz: 100%    944 B   0.9kB/s    00:01</span>
<span class="go">[myjail1.example.com] Fetching packagesite.txz: 100%    6 MiB   1.6MB/s    00:04</span>
<span class="go">Processing entries: 100%</span>
<span class="go">FreeBSD repository update completed. 31945 packages processed.</span>
<span class="go">All repositories are up to date.</span>
<span class="gp">root@dc03:/ $</span> pkg install -y bash
</code></pre></div>

<h3 id="install-packages-you-need">Install packages you need<a class="headerlink" href="#install-packages-you-need" title="Permanent link">&para;</a></h3>
<p>Now, install any packages you may need. I tend to install my favourite
shell <code class="codehilite"><span class="err">bash</span></code></p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../secure-server/" title="A Secure FreeBSD Server in the cloud" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                A Secure FreeBSD Server in the cloud
              </div>
            </div>
          </a>
        
        
          <a href="../ghost/" title="Installing the ghost blogging platform in FreeBSD" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Installing the ghost blogging platform in FreeBSD
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.2d1db4bd.min.js"></script>
      <script src="../../assets/javascripts/bundle.6627ddf3.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>